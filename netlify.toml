# Netlify Configuration
# https://docs.netlify.com/configure-builds/file-based-configuration/

[build]
  command = "npm run build"
  publish = ".next"

[build.environment]
  NODE_VERSION = "20"
  NPM_FLAGS = "--legacy-peer-deps"

# Next.js specific configuration
[[plugins]]
  package = "@netlify/plugin-nextjs"

# Function timeout overrides
[functions]
  # Default timeout is 10 seconds, increase for data collection
  "scheduled-data-collection" = { timeout = 600 }  # 10 minutes

# Scheduled Functions - Daily Data Collection
# Runs at 6:00 AM Paris time (5:00 AM UTC in winter, 4:00 AM UTC in summer)
# Using 5:00 AM UTC to be consistent year-round
[functions."scheduled-data-collection"]
  schedule = "0 5 * * *"

# API route timeouts
[[redirects]]
  from = "/api/data-collection/*"
  to = "/.netlify/functions/api/data-collection/:splat"
  status = 200
  force = true
  [redirects.headers]
    X-Function-Timeout = "300"  # 5 minutes

[[redirects]]
  from = "/api/promises/match"
  to = "/.netlify/functions/api/promises/match"
  status = 200
  force = true
  [redirects.headers]
    X-Function-Timeout = "120"  # 2 minutes

[[redirects]]
  from = "/api/promises/calculate-scores"
  to = "/.netlify/functions/api/promises/calculate-scores"
  status = 200
  force = true
  [redirects.headers]
    X-Function-Timeout = "120"  # 2 minutes

[[redirects]]
  from = "/api/admin/full-analysis"
  to = "/.netlify/functions/api/admin/full-analysis"
  status = 200
  force = true
  [redirects.headers]
    X-Function-Timeout = "600"  # 10 minutes for full data collection

# Environment variables documentation
# Required environment variables:
# - NEXT_PUBLIC_SUPABASE_URL
# - NEXT_PUBLIC_SUPABASE_ANON_KEY
# - SUPABASE_SERVICE_ROLE_KEY
# - HUGGINGFACE_API_KEY
# - CRON_SECRET_TOKEN (for automated cron jobs)
# - ENABLE_CRON (set to "true" to enable)
# - WORLD_NEWS_API_KEY (optional)
# - MAILJET_API_KEY (optional)
# - MAILJET_SECRET_KEY (optional)
